name: main
on:
  workflow_dispatch:
permissions:
  contents: read
  issues: write

jobs:

  validate-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets exist
        env:
          VARS_JSON: ${{ secrets.VARS_JSON }}
        run: |
          for s in VARS_JSON; do
            if [ -z "${!s}" ]; then
              echo "Error: Missing required secret: $s"
              exit 1
            fi
          done
          echo "All required secrets exist"
      - name: Validate VARS_JSON schema
        env:
          VARS: ${{ secrets.VARS_JSON }}
        run: |
          jq -e '
            (.aws_access_key_id     | type=="string") and
            (.aws_secret_access_key | type=="string") and
            (.aws_region            | type=="string") and
            (.cf_token              | type=="string") and
            (.uptimerobot_token     | type=="string") and
            (.admin_ip              | type=="string") and
            (.project_name          | type=="string") and
            (.instance_type         | type=="string") and
            (.instance_disk_size    | type=="string") and
            (.sites | type=="object") and
            (
              (.sites | length) == 0 or
              (all(.sites[]; (type=="object") and (.domain | type=="string") and (.monitor_keyworkd | type=="string")))
            )
          ' <<<"$VARS" >/dev/null || { echo "Error: VARS_JSON schema invalid"; exit 1; }
          echo "VARS_JSON schema valid"

  prepare-backend:
    runs-on: ubuntu-latest
    needs: validate-secrets
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ fromJson(secrets.VARS_JSON).aws_access_key_id }}
          aws-secret-access-key: ${{ fromJson(secrets.VARS_JSON).aws_secret_access_key }}
          aws-region: ${{ fromJson(secrets.VARS_JSON).aws_region }}
      - name: Creates / Checks state bucket
        env:
          BUCKET_NAME: ${{ fromJson(secrets.VARS_JSON).project_name }}-bucket-tfstate
          AWS_REGION: ${{ fromJson(secrets.VARS_JSON).aws_region }}
        run: |
          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "Bucket already exists: $BUCKET_NAME"
          else
            echo "Bucket does not exist. Creating: $BUCKET_NAME"
            aws s3api create-bucket --bucket "$BUCKET_NAME" \
              --region "$AWS_REGION" \
              --create-bucket-configuration LocationConstraint="$AWS_REGION"

            echo "Applying public access block to $BUCKET_NAME"
            aws s3api put-public-access-block --bucket "$BUCKET_NAME" --public-access-block-configuration BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true

            echo "Enabling versioning for $BUCKET_NAME"
            aws s3api put-bucket-versioning --bucket "$BUCKET_NAME" --versioning-configuration Status=Enabled

            echo "Enabling default encryption (SSE-S3) for $BUCKET_NAME"
            aws s3api put-bucket-encryption --bucket "$BUCKET_NAME" --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
          fi
      - name: Create TF Backend (jq -> backend.tf.json)
        env:
          BUCKET_NAME: ${{ fromJson(secrets.VARS_JSON).project_name }}-bucket-tfstate
          AWS_REGION: ${{ fromJson(secrets.VARS_JSON).aws_region }}
        run: |
          tee backend.tf > /dev/null <<EOF
          terraform {
            backend "s3" {
              bucket = "$BUCKET_NAME"
              key    = "terraform.tfstate"
              region = "$AWS_REGION"
              encrypt = true
            }
          }
          EOF
          echo "backend.tf created"
      - name: Upload backend.tf
        uses: actions/upload-artifact@v4
        with:
          name: tfbackend
          path: backend.tf

  prepare-tfvars:
    runs-on: ubuntu-latest
    needs: validate-secrets
    steps:
      - name: Generate terraform.auto.tfvars.json
        env:
          VARS: ${{ secrets.VARS_JSON }}
        run: |
          echo "Storing keys into terraform.auto.tfvars.json:"
          echo "$VARS" | jq -r 'keys[]' | sed "s/^/ - /"
          printf '%s\n' "$VARS" > terraform.auto.tfvars.json
      - name: Upload terraform.auto.tfvars.json
        uses: actions/upload-artifact@v4
        with:
          name: tfvars
          path: terraform.auto.tfvars.json
          
artifacts:
  runs-on: ubuntu-latest
  env:
    BUILD_DIR: "build"
    ARTIFACTS_DIR: "artifacts"
    BUILD_LAMBDA_DIR: "build/lambda"
    BUILD_ANSIBLE_DIR: "build/ansible"
    ARTIFACTS_LAMBDA_DIR: "artifacts/lambda"
    ARTIFACTS_ANSIBLE_DIR: "artifacts/ansible"
  steps:
    - name: Checkout repo
      uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    - name: Upgrade pip
      run: python -m pip install --upgrade pip
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: "20"
    - name: Check build structure
      run: |
        if [[ ! -d "$BUILD_DIR" ]]; then
          echo "::error::Missing required folder: $BUILD_DIR"
          exit 1
        fi
    - name: Create artifacts folder
      run: |
        mkdir -p "$ARTIFACTS_DIR"
        mkdir -p "$ARTIFACTS_ANSIBLE_DIR"
        mkdir -p "$ARTIFACTS_LAMBDA_DIR"
    - name: Scan build lambdas + install dependencies
      if: ${{ hashFiles(format('{0}/*', env.BUILD_LAMBDA_DIR)) != '' }}
      run: |
        for d in "$BUILD_LAMBDA_DIR"/*; do
          name="$(basename "$d")"
          if [[ -f "$d/requirements.txt" ]]; then
            echo "Lambda $name: python"
            mkdir -p "$d/packages"
            python -m pip install -r "$d/requirements.txt" -t "$d/packages"
            continue
          fi
          if [[ -f "$d/package.json" ]]; then
            echo "Lambda $name: nodejs"
            (cd "$d" && npm ci --omit=dev)
            continue
          fi
          echo "::error::Lambda $name runtime unknown (add requirements.txt or package.json)"
          exit 1
        done
    - name: Zip lambdas into artifacts
      if: ${{ hashFiles(format('{0}/*', env.BUILD_LAMBDA_DIR)) != '' }}
      run: for d in "$BUILD_LAMBDA_DIR"/*; do zip -r "$ARTIFACTS_LAMBDA_DIR/$(basename "$d").zip" "$d"; done
    - name: Zip ansible into artifacts
      if: ${{ hashFiles(format('{0}/*', env.BUILD_ANSIBLE_DIR)) != '' }}
      run: for d in "$BUILD_ANSIBLE_DIR"/*; do zip -r "$ARTIFACTS_ANSIBLE_DIR/$(basename "$d").zip" "$d"; done
    - name: Upload artifacts folder
      uses: actions/upload-artifact@v4
      with:
        name: artifacts
        path: artifacts/

  tf-plan:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - prepare-backend
      - prepare-tfvars
      - artifacts
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ fromJson(secrets.VARS_JSON).aws_access_key_id }}
          aws-secret-access-key: ${{ fromJson(secrets.VARS_JSON).aws_secret_access_key }}
          aws-region: ${{ fromJson(secrets.VARS_JSON).aws_region }}
      - name: Download backend.tf
        uses: actions/download-artifact@v4
        with:
          name: tfbackend
          path: .
      - name: Download tfvars
        uses: actions/download-artifact@v4
        with:
          name: tfvars
          path: .
      - name: Terraform init
        run: terraform init -input=false
      - name: Terraform plan
        run: terraform plan -input=false -no-color -out=tfplan
      - name: Generate visual plan
        run: terraform show -no-color tfplan > tfplan_visual
      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-artifacts
          path: |
            tfplan
            tfplan_visual

  approbal:
    runs-on: ubuntu-latest
    needs: tf-plan
    steps:
      - name: Download tfplan artifacts
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: .
      - name: Await Manual Approval
        timeout-minutes: 5
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          minimum-approvals: 1
          approvers: ${{ github.actor }}
          issue-title: "Manual Approval Required for Terraform Apply"
          issue-body-file-path: tfplan_visual

  tf-apply:
    runs-on: ubuntu-latest
    needs:
      - approbal
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ fromJson(secrets.VARS_JSON).aws_access_key_id }}
          aws-secret-access-key: ${{ fromJson(secrets.VARS_JSON).aws_secret_access_key }}
          aws-region: ${{ fromJson(secrets.VARS_JSON).aws_region }}
      - name: Install Ansible
        run: sudo apt-get install -y ansible
      - name: Download tfplan artifacts
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: .
      - name: Download tfbackend
        uses: actions/download-artifact@v4
        with:
          name: tfbackend
          path: .
      - name: Download tfvars
        uses: actions/download-artifact@v4
        with:
          name: tfvars
          path: .
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts
          path: .
      - name: Set execute permissions for scripts
        run: |
          if [ -d "./scripts" ]; then
            chmod +x ./scripts/*.sh || true
            ls -l ./scripts
          else
            echo "Directory ./scripts does not exist"
            exit 1
          fi
      - name: Terraform init
        run: terraform init -input=false
      - name: Terraform apply
        run: terraform apply -auto-approve tfplan