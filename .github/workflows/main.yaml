name: main
on:
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  validate-secrets:
    runs-on: ubuntu-latest
    env:
      VARS_JSON: ${{ secrets.VARS_JSON }}
      SA_JSON: ${{ secrets.SA_JSON }}
      VARS_FILE: "vars.json"
      SERVICE_ACCOUNT_FILE: "sa.json"
      SCHEMA_DIR: "./.github/schemas"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
      - name: Save VARS_JSON as file
        run: printf '%s' "$VARS_JSON" > $VARS_FILE
      - name: Save SA_JSON as file
        run: printf '%s' "$SA_JSON" > $SERVICE_ACCOUNT_FILE
      - name: Validate VARS_JSON
        uses: GrantBirki/json-yaml-validate@v4.0.0
        with:
          json_schema: "${{ env.SCHEMA_DIR }}/${{ env.VARS_FILE }}"
          files:  ${{ env.VARS_FILE }}
          comment: "true"
      - name: Validate SA_JSON
        uses: GrantBirki/json-yaml-validate@v4.0.0
        with:
          json_schema: "${{ env.SCHEMA_DIR }}/${{ env.SA_SCHEMA }}"
          files:  ${{ env.SERVICE_ACCOUNT_FILE }}
          comment: "true"

  prepare-tfbackend:
    runs-on: ubuntu-latest
    needs: validate-secrets
    env:
      BUCKET_NAME: ${{ fromJson(secrets.VARS_JSON).project_name }}-bucket-tfstate
      AWS_REGION: ${{ fromJson(secrets.SA_JSON).aws_region }}
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ fromJson(secrets.SA_JSON).aws_access_key_id }}
          aws-secret-access-key: ${{ fromJson(secrets.SA_JSON).aws_secret_access_key }}
          aws-region: ${{ fromJson(secrets.SA_JSON).aws_region }}
      - name: Creates / Checks state bucket
        run: |
          set -euo pipefail
          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "Bucket already exists: $BUCKET_NAME"
          else
            echo "Bucket does not exist. Creating: $BUCKET_NAME"
            aws s3api create-bucket --bucket "$BUCKET_NAME" \
              --region "$AWS_REGION" \
              --create-bucket-configuration LocationConstraint="$AWS_REGION"
            echo "Applying public access block to $BUCKET_NAME"
            aws s3api put-public-access-block --bucket "$BUCKET_NAME" --public-access-block-configuration BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true
            echo "Enabling versioning for $BUCKET_NAME"
            aws s3api put-bucket-versioning --bucket "$BUCKET_NAME" --versioning-configuration Status=Enabled
            echo "Enabling default encryption (SSE-S3) for $BUCKET_NAME"
            aws s3api put-bucket-encryption --bucket "$BUCKET_NAME" --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
          fi
      - name: Create TF Backend (backend.tf)
        run: |
          tee backend.tf > /dev/null <<EOF
          terraform {
            backend "s3" {
              bucket       = "$BUCKET_NAME"
              key          = "terraform.tfstate"
              use_lockfile = true
              region       = "$AWS_REGION"
              encrypt      = true
            }
          }
          EOF
          echo "backend.tf created"
      - name: Upload backend.tf
        uses: actions/upload-artifact@v4
        with:
          name: tfbackend
          path: backend.tf

  prepare-tfvars:
    runs-on: ubuntu-latest
    needs: validate-secrets
    steps:
      - name: Generate tfvars.json
        env:
          VARS: ${{ secrets.VARS_JSON }}
        run: |
          echo "Storing keys into tfvars.json:"
          echo "$VARS" | jq -r 'keys[]' | sed "s/^/ - /"
          printf '%s\n' "$VARS" > tfvars.json
      - name: Upload tfvars.json
        uses: actions/upload-artifact@v4
        with:
          name: tfvars
          path: tfvars.json

  prepare-artifacts:
    runs-on: ubuntu-latest
    needs: validate-secrets
    env:
      BUILD_DIR: build
      ARTIFACTS_DIR: artifacts
      LAMBDA_DIR: lambda
      PYTHON_DIR: python
      NODEJS_DIR: nodejs
      ANSIBLE_DIR: ansible
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Cache python lambda build
        id: cache-artifacts-python
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_DIR }}/${{ env.LAMBDA_DIR }}/$PYTHON_DIR/**/packages
          key: ${{ runner.os }}-lambda-python-${{ hashFiles('build/lambda/**') }}
          restore-keys: |
            ${{ runner.os }}-lambda-python-artifacts-
      - name: Cache nodejs lambda build
        id: cache-artifacts-nodejs
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_DIR }}/${{ env.LAMBDA_DIR }}/$NODEJS_DIR/**/node_modules
          key: ${{ runner.os }}-lambda-node-${{ hashFiles('build/lambda/**') }}
          restore-keys: |
            ${{ runner.os }}-lambda-node-artifacts-
      - name: Build lambda python
        if: steps.cache-artifacts-python.outputs.cache-hit != 'true'
        run: |
          found=0
          for d in "$BUILD_DIR/$LAMBDA_DIR/$PYTHON_DIR"/*; do
            if [[ -f "$d/requirements.txt" ]]; then
              found=1
              echo "Building python lambda $(basename "$d")"
              mkdir -p "$d/packages"
              python -m pip install -r "$d/requirements.txt" -t "$d/packages"
            fi
          done
          if [[ "$found" -eq 0 ]]; then
            echo "No requirements.txt found in $BUILD_DIR/$LAMBDA_DIR/$PYTHON_DIR/*; skipping python build."
          fi
      - name: Build lambda nodejs
        if: steps.cache-artifacts-nodejs.outputs.cache-hit != 'true'
        run: |
          found=0
          for d in "$BUILD_DIR/$LAMBDA_DIR/$NODEJS_DIR"/*; do
            if [[ -f "$d/package.json" ]]; then
              found=1
              echo "Building node lambda $(basename "$d")"
              (cd "$d" && npm ci --omit=dev)
            fi
          done
          if [[ "$found" -eq 0 ]]; then
            echo "No package.json found in $BUILD_DIR/$LAMBDA_DIR/$NODEJS_DIR/*; skipping node build."
          fi
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: build

  tf-plan:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - prepare-tfbackend
      - prepare-tfvars
    env:
      TF_PLUGIN_CACHE_DIR: ${{ github.workspace }}/.terraform.d/plugin-cache
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ fromJson(secrets.SA_JSON).aws_access_key_id }}
          aws-secret-access-key: ${{ fromJson(secrets.SA_JSON).aws_secret_access_key }}
          aws-region: ${{ fromJson(secrets.SA_JSON).aws_region }}
      - name: Download tfbackend
        uses: actions/download-artifact@v4
        with:
          name: tfbackend
          path: ""
      - name: Download tfvars
        uses: actions/download-artifact@v4
        with:
          name: tfvars
          path: ""
      - name: Create plugin cache dir
        run: mkdir -p "${TF_PLUGIN_CACHE_DIR}"
      - name: Cache Terraform providers
        id: tfinit-providers
        uses: actions/cache@v4
        with:
          path: ${{ env.TF_PLUGIN_CACHE_DIR }}
          key: ${{ runner.os }}-tfinit-providers-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-tfproviders-
      - name: Terraform init
        run: terraform init -input=false -lockfile=readonly
      - name: Terraform plan
        run: terraform plan -input=false -no-color -out=tfplan -var-file="tfvars.json"
      - name: Generate visual plan
        run: terraform show -no-color tfplan > tfplan_visual
      - name: Upload tfplan_visual
        uses: actions/upload-artifact@v4
        with:
          name: tfplan_visual
          path: tfplan_visual
      - name: Upload tfplan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: tfplan

  approbal:
    runs-on: ubuntu-latest
    needs: tf-plan
    steps:
      - name: Download tfplan_visual
        uses: actions/download-artifact@v4
        with:
          name: tfplan_visual
          path: .
      - name: Await Manual Approval
        timeout-minutes: 5
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          minimum-approvals: 1
          approvers: ${{ github.actor }}
          issue-title: "Manual Approval Required for Terraform Apply"
          issue-body-file-path: tfplan_visual

  tf-apply:
    runs-on: ubuntu-latest
    needs:
      - approbal
      - prepare-artifacts
    env:
      TF_PLUGIN_CACHE_DIR: ${{ github.workspace }}/.terraform.d/plugin-cache
      ARTIFACTS_DIR: "./artifacts"
      SCRIPTS_DIR: "./scripts"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ fromJson(secrets.SA_JSON).aws_access_key_id }}
          aws-secret-access-key: ${{ fromJson(secrets.SA_JSON).aws_secret_access_key }}
          aws-region: ${{ fromJson(secrets.SA_JSON).aws_region }}
      - name: Install Ansible
        run: sudo apt-get update && sudo apt-get install -y ansible
      - name: Create tf providers dir
        run: mkdir -p "${TF_PLUGIN_CACHE_DIR}"
      - name: Create artifacts dir
        run: mkdir -p "${ARTIFACTS_DIR}"
      - name: Set execute permissions for scripts
        run: |
          if [ -d $SCRIPTS_DIR ]; then
            chmod +x $SCRIPTS_DIR/*.sh || true
            ls -l $SCRIPTS_DIR
          else
            echo "Directory $SCRIPTS_DIR does not exist"
            exit 1
          fi
      - name: Download tfplan
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: ""
      - name: Download tfbackend
        uses: actions/download-artifact@v4
        with:
          name: tfbackend
          path: ""
      - name: Download tfvars
        uses: actions/download-artifact@v4
        with:
          name: tfvars
          path: ""
      - name: Download artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: ${{ env.ARTIFACTS_DIR }}
      - name: Cache Terraform providers (plugin cache)
        id: tfinit-providers
        uses: actions/cache@v4
        with:
          path: ${{ env.TF_PLUGIN_CACHE_DIR }}
          key: ${{ runner.os }}-tfinit-providers-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-tfinit-providers-
      - name: Terraform init
        run: terraform init -input=false -lockfile=readonly
      - name: Terraform apply
        run: terraform apply -auto-approve tfplan -var-file="tfvars.json"