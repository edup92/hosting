name: main
on:
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  validate-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets exist
        env:
          VARS_JSON: ${{ secrets.VARS_JSON }}
          SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT }}
        run: |
          for s in VARS_JSON SERVICE_ACCOUNT; do
            if [ -z "${!s}" ]; then
              echo "Error: Missing required secret: $s"
              exit 1
            fi
          done
          echo "All required secrets exist"

      #- name: Test
      #  uses: cardinalby/schema-validator-action@3.1.1
      #  id: json-yaml-validate
      #  with:
      #    json_schema: ./github/schemas/vars_json.json
      #    files: config/valid.json
      #    comment: "true"

      - name: Validate VARS_JSON schema
        env:
          VARS: ${{ secrets.VARS_JSON }}
        run: |
          jq -e '
            (.cf_token              | type=="string") and
            (.uptimerobot_token     | type=="string") and
            (.admin_ip              | type=="string") and
            (.project_name          | type=="string") and
            (.instance_type         | type=="string") and
            (.instance_disk_size    | type=="string") and
            (.sites | type=="object") and
            (
              (.sites | length) == 0 or
              (all(.sites[]; (type=="object") and (.domain | type=="string") and (.monitor_keyworkd | type=="string")))
            )
          ' <<<"$VARS" >/dev/null || { echo "Error: VARS_JSON schema invalid"; exit 1; }
          echo "VARS_JSON schema valid"
      - name: Validate SERVICE_ACCOUNT schema
        env:
          SA: ${{ secrets.SERVICE_ACCOUNT }}
        run: |
          jq -e '
            (.aws_access_key_id | type=="string") and
            (.aws_secret_access_key | type=="string") and
            (.aws_region | type=="string")
          ' <<<"$SA" >/dev/null || { echo "Error: SERVICE_ACCOUNT schema invalid"; exit 1; }
          echo "SERVICE_ACCOUNT schema valid"

  prepare-tfbackend:
    runs-on: ubuntu-latest
    needs: validate-secrets
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ fromJson(secrets.SERVICE_ACCOUNT).aws_access_key_id }}
          aws-secret-access-key: ${{ fromJson(secrets.SERVICE_ACCOUNT).aws_secret_access_key }}
          aws-region: ${{ fromJson(secrets.SERVICE_ACCOUNT).aws_region }}
      - name: Creates / Checks state bucket
        env:
          BUCKET_NAME: ${{ fromJson(secrets.VARS_JSON).project_name }}-bucket-tfstate
          AWS_REGION: ${{ fromJson(secrets.SERVICE_ACCOUNT).aws_region }}
        run: |
          set -euo pipefail
          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "Bucket already exists: $BUCKET_NAME"
          else
            echo "Bucket does not exist. Creating: $BUCKET_NAME"
            aws s3api create-bucket --bucket "$BUCKET_NAME" \
              --region "$AWS_REGION" \
              --create-bucket-configuration LocationConstraint="$AWS_REGION"
            echo "Applying public access block to $BUCKET_NAME"
            aws s3api put-public-access-block --bucket "$BUCKET_NAME" --public-access-block-configuration BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true
            echo "Enabling versioning for $BUCKET_NAME"
            aws s3api put-bucket-versioning --bucket "$BUCKET_NAME" --versioning-configuration Status=Enabled
            echo "Enabling default encryption (SSE-S3) for $BUCKET_NAME"
            aws s3api put-bucket-encryption --bucket "$BUCKET_NAME" --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
          fi
      - name: Create TF Backend (backend.tf)
        env:
          BUCKET_NAME: ${{ fromJson(secrets.VARS_JSON).project_name }}-bucket-tfstate
          AWS_REGION: ${{ fromJson(secrets.SERVICE_ACCOUNT).aws_region }}
        run: |
          tee backend.tf > /dev/null <<EOF
          terraform {
            backend "s3" {
              bucket       = "$BUCKET_NAME"
              key          = "terraform.tfstate"
              use_lockfile = true
              region       = "$AWS_REGION"
              encrypt      = true
            }
          }
          EOF
          echo "backend.tf created"
      - name: Upload backend.tf
        uses: actions/upload-artifact@v4
        with:
          name: tfbackend
          path: backend.tf

  prepare-tfvars:
    runs-on: ubuntu-latest
    needs: validate-secrets
    steps:
      - name: Generate terraform.auto.tfvars.json
        env:
          VARS: ${{ secrets.VARS_JSON }}
        run: |
          echo "Storing keys into terraform.auto.tfvars.json:"
          echo "$VARS" | jq -r 'keys[]' | sed "s/^/ - /"
          printf '%s\n' "$VARS" > terraform.auto.tfvars.json
      - name: Upload terraform.auto.tfvars.json
        uses: actions/upload-artifact@v4
        with:
          name: tfvars
          path: terraform.auto.tfvars.json

  prepare-artifacts:
    runs-on: ubuntu-latest
    env:
      BUILD_DIR: build
      BUILD_LAMBDA_DIR: build/lambda
      BUILD_ANSIBLE_DIR: build/ansible
      ARTIFACTS_DIR: artifacts
      ARTIFACTS_LAMBDA_DIR: artifacts/lambda
      ARTIFACTS_ANSIBLE_DIR: artifacts/ansible
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Cache python lambda build
        id: cache-python
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_LAMBDA_DIR }}/**/packages
          key: ${{ runner.os }}-lambda-py-${{ hashFiles('build/lambda/**') }}
          restore-keys: |
            ${{ runner.os }}-lambda-py-
      - name: Cache node lambda build
        id: cache-node
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_LAMBDA_DIR }}/**/node_modules
          key: ${{ runner.os }}-lambda-node-${{ hashFiles('build/lambda/**') }}
          restore-keys: |
            ${{ runner.os }}-lambda-node-
      - name: Create artifacts folders
        run: |
          mkdir -p "$ARTIFACTS_LAMBDA_DIR"
          mkdir -p "$ARTIFACTS_ANSIBLE_DIR"
      - name: Build python lambdas (cache-aware)
        if: steps.cache-python.outputs.cache-hit != 'true'
        run: |
          found=0
          for d in "$BUILD_LAMBDA_DIR"/*; do
            if [[ -f "$d/requirements.txt" ]]; then
              found=1
              echo "Building python lambda $(basename "$d")"
              mkdir -p "$d/packages"
              python -m pip install -r "$d/requirements.txt" -t "$d/packages"
            fi
          done
          if [[ "$found" -eq 0 ]]; then
            echo "No requirements.txt found in $BUILD_LAMBDA_DIR/*; skipping python build."
          fi
      - name: Build node lambdas (cache-aware)
        if: steps.cache-node.outputs.cache-hit != 'true'
        run: |
          found=0
          for d in "$BUILD_LAMBDA_DIR"/*; do
            if [[ -f "$d/package.json" ]]; then
              found=1
              echo "Building node lambda $(basename "$d")"
              (cd "$d" && npm ci --omit=dev)
            fi
          done
          if [[ "$found" -eq 0 ]]; then
            echo "No package.json found in $BUILD_LAMBDA_DIR/*; skipping node build."
          fi
      - name: Cache lambda zip artifacts
        id: cache-lambda-zips
        uses: actions/cache@v4
        with:
          path: ${{ env.ARTIFACTS_LAMBDA_DIR }}
          key: ${{ runner.os }}-lambda-zips-${{ hashFiles('build/lambda/**') }}
          restore-keys: |
            ${{ runner.os }}-lambda-zips-
      - name: Cache ansible zip artifacts
        id: cache-ansible-zips
        uses: actions/cache@v4
        with:
          path: ${{ env.ARTIFACTS_ANSIBLE_DIR }}
          key: ${{ runner.os }}-ansible-zips-${{ hashFiles('build/ansible/**') }}
          restore-keys: |
            ${{ runner.os }}-ansible-zips-
      - name: Zip lambdas
        if: steps.cache-lambda-zips.outputs.cache-hit != 'true'
        run: |
          for d in "$BUILD_LAMBDA_DIR"/*; do
            name="$(basename "$d")"
            echo "Zipping lambda $name"
            (cd "$d" && zip -r "$GITHUB_WORKSPACE/$ARTIFACTS_LAMBDA_DIR/$name.zip" .)
          done
      - name: Zip ansible
        if: steps.cache-ansible-zips.outputs.cache-hit != 'true'
        run: |
          for d in "$BUILD_ANSIBLE_DIR"/*; do
            name="$(basename "$d")"
            echo "Zipping ansible $name"
            (cd "$d" && zip -r "$GITHUB_WORKSPACE/$ARTIFACTS_ANSIBLE_DIR/$name.zip" .)
          done
      - name: Cache artifacts.zip
        id: cache-artifacts-zip
        uses: actions/cache@v4
        with:
          path: artifacts.zip
          key: ${{ runner.os }}-artifacts-zip-${{ hashFiles('build/**') }}
          restore-keys: |
            ${{ runner.os }}-artifacts-zip-
      - name: Zip artifacts root folder
        if: steps.cache-artifacts-zip.outputs.cache-hit != 'true'
        run: cd "$GITHUB_WORKSPACE" && zip -r artifacts.zip artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: artifacts.zip

  tf-plan:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - prepare-tfbackend
      - prepare-tfvars
    env:
      TF_PLUGIN_CACHE_DIR: ${{ github.workspace }}/.terraform.d/plugin-cache
      TF_DIR: .
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ fromJson(secrets.SERVICE_ACCOUNT).aws_access_key_id }}
          aws-secret-access-key: ${{ fromJson(secrets.SERVICE_ACCOUNT).aws_secret_access_key }}
          aws-region: ${{ fromJson(secrets.SERVICE_ACCOUNT).aws_region }}
      - name: Download tfbackend
        uses: actions/download-artifact@v4
        with:
          name: tfbackend
          path: ${{ env.TF_DIR }}
      - name: Download tfvars
        uses: actions/download-artifact@v4
        with:
          name: tfvars
          path: ${{ env.TF_DIR }}
      - name: Create plugin cache dir
        run: mkdir -p "${TF_PLUGIN_CACHE_DIR}"
      - name: Cache terraform (workdir .terraform + plugin cache)
        id: cache-terraform
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.TF_DIR }}/.terraform
            ${{ env.TF_PLUGIN_CACHE_DIR }}
          key: ${{ runner.os }}-tf-${{ hashFiles('**/*.tf', '**/*.tf.json', '.terraform.lock.hcl', 'backend.tf') }}
          restore-keys: |
            ${{ runner.os }}-tf-

      - name: Debug terraform cache restore
        run: |
          echo "cache-hit: ${{ steps.cache-terraform.outputs.cache-hit }}"
          ls -la "${{ env.TF_DIR }}/.terraform" || true
          ls -la "${{ env.TF_DIR }}/.terraform/modules" || true
          du -sh "${{ env.TF_DIR }}/.terraform" || true
          du -sh "${TF_PLUGIN_CACHE_DIR}" || true

      - name: Terraform init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init -input=false
      - name: Terraform plan
        working-directory: ${{ env.TF_DIR }}
        run: terraform plan -input=false -no-color -out=tfplan
      - name: Generate visual plan
        working-directory: ${{ env.TF_DIR }}
        run: terraform show -no-color tfplan > tfplan_visual
      - name: Upload tfplan_visual
        uses: actions/upload-artifact@v4
        with:
          name: tfplan_visual
          path: ${{ env.TF_DIR }}/tfplan_visual
      - name: Upload tfplan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: ${{ env.TF_DIR }}/tfplan

  approbal:
    runs-on: ubuntu-latest
    needs: tf-plan
    steps:
      - name: Download tfplan_visual
        uses: actions/download-artifact@v4
        with:
          name: tfplan_visual
          path: .
      - name: Await Manual Approval
        timeout-minutes: 5
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          minimum-approvals: 1
          approvers: ${{ github.actor }}
          issue-title: "Manual Approval Required for Terraform Apply"
          issue-body-file-path: tfplan_visual

  tf-apply:
    runs-on: ubuntu-latest
    needs:
      - approbal
    env:
      TF_PLUGIN_CACHE_DIR: ${{ github.workspace }}/.terraform.d/plugin-cache
      TF_DIR: .
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ fromJson(secrets.SERVICE_ACCOUNT).aws_access_key_id }}
          aws-secret-access-key: ${{ fromJson(secrets.SERVICE_ACCOUNT).aws_secret_access_key }}
          aws-region: ${{ fromJson(secrets.SERVICE_ACCOUNT).aws_region }}
      - name: Install Ansible
        run: sudo apt-get update && sudo apt-get install -y ansible
      - name: Download tfplan
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: ${{ env.TF_DIR }}
      - name: Download tfbackend
        uses: actions/download-artifact@v4
        with:
          name: tfbackend
          path: ${{ env.TF_DIR }}
      - name: Download tfvars
        uses: actions/download-artifact@v4
        with:
          name: tfvars
          path: ${{ env.TF_DIR }}
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts
          path: .
      - name: Unzip artifacts.zip to workspace root and remove zip
        run: |
          unzip -o artifacts.zip -d "$GITHUB_WORKSPACE"
          rm -f artifacts.zip
      - name: Create plugin cache dir
        run: mkdir -p "${TF_PLUGIN_CACHE_DIR}"
      - name: Cache terraform (workdir .terraform + plugin cache)
        id: cache-terraform
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.TF_DIR }}/.terraform
            ${{ env.TF_PLUGIN_CACHE_DIR }}
          key: ${{ runner.os }}-tf-${{ hashFiles('**/*.tf', '**/*.tf.json', '.terraform.lock.hcl', 'backend.tf') }}
          restore-keys: |
            ${{ runner.os }}-tf-

      - name: Debug terraform cache restore
        run: |
          echo "cache-hit: ${{ steps.cache-terraform.outputs.cache-hit }}"
          ls -la "${{ env.TF_DIR }}/.terraform" || true
          ls -la "${{ env.TF_DIR }}/.terraform/modules" || true
          du -sh "${{ env.TF_DIR }}/.terraform" || true
          du -sh "${TF_PLUGIN_CACHE_DIR}" || true

      - name: Terraform init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init -input=false
      - name: Set execute permissions for scripts
        run: |
          if [ -d "./scripts" ]; then
            chmod +x ./scripts/*.sh || true
            ls -l ./scripts
          else
            echo "Directory ./scripts does not exist"
            exit 1
          fi
      - name: Terraform apply
        working-directory: ${{ env.TF_DIR }}
        run: terraform apply -auto-approve tfplan
