---
- name: cloudpanel
  hosts: all
  gather_facts: true
  become: true

  tasks:

    - name: Ensure APT is updated and basic packages installed
      block:
        - name: Update APT cache
          apt:
            update_cache: true
            cache_valid_time: 3600
        - name: Basic Packages
          apt:
            name:
              - software-properties-common
              - gnupg
              - curl
              - ca-certificates
              - nano
              - unzip
              - wget
            state: present
            update_cache: true

    - name: Check OS compatibility
      fail:
        msg: "CloudPanel only allowed in Ubuntu 24.04."
      when: >
        ansible_facts['distribution'] != 'Ubuntu'
        or ansible_facts['distribution_version'] is version('24.04', '!=')

    - name: Install Cloudpanel
      block:
        - name: Check if clpctl exists
          shell: command -v clpctl
          register: clpctl_check
          ignore_errors: true
          changed_when: false
          failed_when: false
        - name: Download CloudPanel installer
          get_url:
            url: https://installer.cloudpanel.io/ce/v2/install.sh
            dest: /tmp/install.sh
            mode: '0755'
            force: yes
          when: clpctl_check.rc != 0
        - name: Verify SHA256 checksum
          shell: >
            echo "19cfa702e7936a79e47812ff57d9859175ea902c62a68b2c15ccd1ebaf36caeb  /tmp/install.sh"
            | sha256sum -c -
          register: checksum
          changed_when: false
          failed_when: checksum.rc != 0
          when: clpctl_check.rc != 0
        - name: Run CloudPanel installer
          shell: |
            DB_ENGINE=MARIADB_11.4 bash /tmp/install.sh
          when: clpctl_check.rc != 0
          async: 1800
          poll: 0
          register: clp_job
        - name: Wait for CloudPanel installation to finish
          async_status:
            jid: "{{ clp_job.ansible_job_id }}"
          register: clp_result
          until: clp_result.finished
          retries: 120
          delay: 10
          when: clpctl_check.rc != 0
        - name: Check if clpctl exists
          shell: command -v clpctl

    - name: Add sites
      block:
        - name: Add sites (clpctl)
          command: >
            clpctl site:add:php
            --domainName={{ item.value.domain }}
            --phpVersion=8.2
            --vhostTemplate=Generic
            --siteUser={{ (item.value.domain | split('.'))[0] }}
            --siteUserPassword={{ lookup('ansible.builtin.password', '/dev/null length=14 chars=ascii_letters,digits') }}
          loop: "{{ sites | dict2items }}"
          changed_when: true
        - name: Add databases (clpctl)
          command: >
            clpctl db:add
            --domainName={{ item.value.domain }}
            --databaseName={{ (item.value.domain | split('.'))[0] }}
            --databaseUserName={{ (item.value.domain | split('.'))[0] }}
            --databaseUserPassword={{ db_pass }}
          loop: "{{ sites | dict2items }}"
          loop_control:
            label: "{{ item.value.domain }}"
          vars:
            db_pass: "{{ lookup('ansible.builtin.password', '/dev/null length=14 chars=ascii_letters,digits') }}"
          register: db_add
          changed_when: true
        - name: Show generated DB passwords (per domain)
          debug:
            msg: "Domain={{ item.item.value.domain }} DBUser={{ (item.item.value.domain | split('.'))[0] }} DBPassword={{ item.item.vars.db_pass | default('UNKNOWN') }}"
          loop: "{{ db_add.results }}"
          loop_control:
            label: "{{ item.item.value.domain }}"
          no_log: false